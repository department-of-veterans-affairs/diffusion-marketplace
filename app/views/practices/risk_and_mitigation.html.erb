<% provide :head_tags do %>
    <%= javascript_tag 'data-turbolinks-track': 'reload' do %>
        <%= render partial: 'risk_and_mitigation', formats: [:js] %>
    <% end %>
    <%= javascript_include_tag 'practice_editor_risk_mitigation', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag '_practice_editor_utilities', 'data-turbolinks-track': 'reload' %>
<% end %>

<%= render 'breadcrumbs' %>
<%= render 'practice_editor_sidenav' %>
<div class="grid-container position-relative">
    <div class="grid-row grid-gap practice-editor-min-height">
        <div class="desktop:grid-col-3 grid-col-auto z-bottom">&nbsp;</div>

        <div id="risk-mitigation" class="desktop:grid-col-9 grid-col-12 p0">
            <%= render "shared/messages" %>
            <section class="usa-section padding-top-0 p2-bottom risk-mitigation">
                <h1 class="font-sans-2xl line-height-sans-205">Risk and mitigation&nbsp;<span class="text-base">(optional)</span></h1>
                <h2 class="text-normal">
                    This section details the difficulties and risks a facility may face when implementing your practice.
                </h2>
                <%= nested_form_for(@practice, html: { multipart: true, style: 'max-width: 100%', class: 'usa-form', id: 'form'}) do |f| %>
                    <fieldset class="usa-fieldset">
                        <legend class="usa-sr-only">Risks and Mitigations</legend>
                        <ul class="practice-editor-risk-mitigation-ul" id="sortable_risk_mitigations" role="listbox" aria-label="Practice editor risk and mitigation pair list">
                        <%= f.fields_for :risk_mitigations, wrapper: false do |rm| %>
                            <%
                                rm_id = rm.object.id
                                rm_position = rm.object.position
                            %>
                            <li class="practice-editor-risk-mitigation-li fields" data-id="<%= rm_id %>">
                                <%= rm.hidden_field :id %>
                                <%= rm.hidden_field :position, class: 'risk-mitigation-position' %>
                                <div class="padding-205 border border-width-1px border-base-lighter radius-sm margin-top-3">

                                    <%= rm.fields_for :risks, wrapper: false do |risk| %>
                                        <%
                                            risk_id = risk.object.id
                                        %>
                                        <%= risk.hidden_field :id %>
                                        <div class="position-relative">
                                            <div class="fas fa-arrows-alt font-sans-lg position-arrows risk-miti-arrows text-base arrows-tooltip">
                                                <span class="usa-tag tooltip-text">Drag and drop to change order</span>
                                            </div>
                                        </div>
                                        <div id="risk_<%= risk_id %>_container" class="risk_<%= risk_id %>_container grid-col-11">
                                            <%= risk.label :description, 'Risk:', class: 'usa-label text-bold display-inline-block risk-description' %>&nbsp;<span>Type the name or description of the risk.</span>&nbsp;<span class="text-base-light risk-character-count risk_<%= risk_id %>_character_count" <% if risk_id.present? %> id="risk_<%= risk_id %>_character_count"<% end %>>(0/150 characters)</span>
                                            <%= risk.text_area :description, class: "usa-input practice-input risk-description-textarea height-15 risk_#{risk_id}_description_textarea", 'counter-id': "risk_#{risk_id}_description_textarea" %>
                                        </div>
                                    <% end %>
                                    <div class="grid-row width-full">
                                        <div class="grid-col-11 mitigation-container">
                                            <%= rm.fields_for :mitigations, wrapper: false do |miti| %>
                                                <%
                                                    mitigation_id = miti.object.id
                                                %>
                                                <%= miti.hidden_field :id %>
                                                <div id="mitigation_<%= mitigation_id %>_container" class="mitigation_<%= mitigation_id %>_container">
                                                    <%= miti.label :description, 'Mitigation:', class: 'usa-label text-bold display-inline-block' %>&nbsp;<span>Type the corresponding mitigation to the risk.</span>&nbsp;<span class="text-base-light mitigation-character-count" <% if mitigation_id.present? %> id="mitigation_<%= mitigation_id %>_character_count"<% end %>>(0/150 characters)</span>
                                                    <%= miti.text_area :description, class: 'usa-input practice-input mitigation-description-textarea height-15', 'counter-id': "mitigation_#{mitigation_id}_description_textarea" %>
                                                </div>
                                            <% end %>
                                        </div>
                                        <div class="grid-col-fill flex-align-end risk-miti-trash-container">
                                            <%= rm.link_to_remove '', class: "fas fa-trash-alt risk-mitigation-trash text-no-underline", 'aria-label': 'Remove' %>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        <% end %>
                        </ul>
                        <%= f.link_to_add :risk_mitigations, class: 'fas fa-plus text-no-underline add-risk-mitigation-link' do %>
                            <span class="padding-left-1 font-sans-md text-normal text-no-underline">Add another</span>
                        <% end %>
                      <ul class="trash-can display-none"></ul>
                    </fieldset>
                <% end %>
                <div class="grid-row margin-bottom-8">
                    <%= link_to practice_timeline_path(@practice), class: 'usa-button usa-button--outline editor-back-to-link margin-right-1 padding-2 margin-bottom-5 text-no-underline' do %>
                        <i class="fas fa-chevron-left fa-sm text-no-underline margin-right-1"></i>Back
                    <% end %>
                    <%= link_to practice_contact_path(@practice), class: 'usa-button padding-2 editor-continue-link margin-right-1 margin-bottom-5' do %>
                        Continue<i class="fas fa-chevron-right fa-sm margin-left-1 text-no-underline"></i>
                    <% end %>
                </div>
            </section>
        </div>
    </div>
    <div class="margin-bottom-105">
        <button class="usa-button usa-button--unstyled return-to-top">Return to top</button>
    </div>
</div>