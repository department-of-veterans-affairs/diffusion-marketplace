function loadScript(src, callback) {
  const script = document.createElement('script');
  script.src = src;
  script.defer = true;
  script.onload = callback;
  document.head.appendChild(script);
}

function loadMapLibraries() {
  if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
    console.log('Google Maps API not ready, retrying...');
    setTimeout(loadMapLibraries, 100);
    return;
  }
  loadScript("https://cdn.jsdelivr.net/gh/mahnunchik/markerclustererplus@master/dist/markerclusterer.min.js", function() {
    loadScript("https://cdn.jsdelivr.net/gh/printercu/google-maps-utility-library-v3-read-only@master/infobox/src/infobox_packed.js", function() {
      loadScript("https://cdn.jsdelivr.net/gh/googlemaps/js-rich-marker@gh-pages/src/richmarker-compiled.js", function() {
        if (window.initialize) {
          window.initialize();
        }
      });
    });
  });
}

document.addEventListener('DOMContentLoaded', function () {
  const GOOGLE_API_KEY = "<%= ENV['GOOGLE_API_KEY'] %>";
  loadScript(`https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&loading=async`, function() {
    loadMapLibraries();
  });
});