<%# TODO: Make compatible with IE %>
<%# TODO: Hover, Click, Visited Interactions %>

<%# TODO: Make unauthenticated view %>
<% provide :head_tags do %>
  <%= javascript_include_tag 'practice_page', 'data-turbolinks-track': 'reload' %>
<% end %>

<%
  updated_at = @practice.updated_at.present? ? @practice.updated_at : @practice.created_at
  completed_adoptions = @practice.number_of_completed_adoptions
  in_progress_adoptions = @practice.number_of_in_progress_adoptions
  unsuccessful_adoptions = @practice.number_of_unsuccessful_adoptions
  has_practice_partners = @practice.practice_partners.any? && @practice.practice_partners.find_by(name: 'None of the above, or Unsure').nil?
  has_practice_awards = @practice.practice_awards.any?
%>

<section id="pr-view-introduction" class="grid-container">
  <div class="grid-row grid-gap-2">
    <%# practice main display image for mobile %>
    <%= render partial: 'practices/show/mobile_partials/main_display_image_container' %>
    <%# practice name %>
    <div class="desktop:grid-col-8 grid-col-12">
      <h1 class="font-sans-2xl margin-top-0 margin-bottom-1 line-height-sans-2 dm-word-break-break-word dm-hyphens-auto">
        <%= display_practice_name(@practice) %>
      </h1>
      <%# practice last update timestamp %>
      <p class="grid-col-12 font-sans-3xs text-gray-50 line-height-sans-4 margin-bottom-2">
        Last updated <%= timeago(updated_at) %>
      </p>
      <%# practice actions %>
      <div class="display-flex flex-wrap margin-bottom-2">
        <%# bookmark %>
        <a href="<%= practice_favorite_path(@practice, format: :js) %>" data-method="post" data-remote="true" rel="nofollow" aria-label="Bookmark <%= @practice.name %>" tabindex="-1" aria-hidden="true" class="dm-favorite-practice-link dm-icon-link text-no-underline font-sans-xs text-primary desktop:grid-col-3 grid-col-6 desktop:margin-bottom-0 margin-bottom-2">
          <i class="<%= current_user.favorite_practice_ids.include?(@practice.id) ? 'fas' : 'far '%> fa-bookmark dm-favorite-icon-<%= @practice.id %>  margin-right-05"></i>
          <span class="dm-favorite-practice-link-text">
            <%= current_user.favorite_practice_ids.include?(@practice.id) ? 'Bookmarked' : 'Bookmark' %>
          </span>
        </a>
        <%# share %>
        <a target="_blank" tabindex="-1" aria-hidden="true"
        aria-label="Share <%= @practice.name %>" href="mailto:?subject=<%= email_practice_subject(@practice) %>&body=<%= email_practice_body(@practice) %>" class="dm-icon-link text-no-underline text-primary font-sans-xs desktop:grid-col-3 grid-col-6 desktop:margin-bottom-0 margin-bottom-2">
          <i class="far fa-share-square margin-right-05"></i>
          <span>Share</span>
        </a>
        <%# subscribe %>
        <span class="font-sans-xs text-no-underline text-gray-50 desktop:grid-col-3 grid-col-6 margin-bottom-0">
          <i class="far fa-bell margin-right-05"></i>Subscribe
        </span>
        <%# print %>
        <a class="dm-icon-link text-no-underline font-sans-xs text-primary desktop:grid-col-3 grid-col-6 margin-bottom-0"
        onclick="window.print(); return false;">
          <i class="fas fa-print margin-right-05"></i>
          <span>Print</span>
        </a>
      </div>
      <%# practice summary %>
      <p class="margin-bottom-2 font-sans-lg line-height-sans-6">
        <%= safe_join(h(@practice.summary).split("\r\n"), tag(:br)) %>
      </p>

      <%# practice origin date and location %>
      <div class="margin-bottom-2">
        <p class="font-sans-3xs line-height-sans-3">
        <span class="text-bold text-uppercase">Origin:</span>
          <span id="practice_origin_facilities_text">
            <% @practice_date =  @practice.date_initiated.present? ? date_format(@practice.date_initiated) : '(start date unknown)'%>
            <%= @practice_date %>,
                <% if origin_display_name(@practice).length > 180 %>
                  <span id="origin_facility_truncated"><%= origin_display_name_trunc(@practice) %></span>
                  <span id="dots">...</span>
                  <span id="more_text" class="display-none">
                    <%= origin_display_name_trunc(@practice, 0, 99999) %>
                  </span><a class="usa-button--unstyled dm-btn-primary font-sans-3xs" href="" onclick="seeMoreText(); return false" id="seeMore">See more</a>
                <% else %>
                  <%= origin_display_name(@practice) %>
                <% end %>
          </span>
        </p>
      </div>
      <%# practice adoptions %>
      <div>
        <% if completed_adoptions > 0 || in_progress_adoptions > 0 || unsuccessful_adoptions > 0 %>
          <p class="grid-col-12 margin-bottom-2 font-sans-3xs line-height-sans-3">
            <%# TODO: link adoptions to new diffusion tracker map %>
            <span class="text-bold text-uppercase">Adoptions:</span>
            <% if completed_adoptions > 0 %>
              <%= completed_adoptions %>&nbsp;completed<%= ', ' if in_progress_adoptions > 0 || unsuccessful_adoptions > 0 %>
            <% end %>
            <% if in_progress_adoptions > 0 %>
              <%= in_progress_adoptions %>&nbsp;in-progress<% ', ' if unsuccessful_adoptions > 0 %>
            <% end %>
            <% if unsuccessful_adoptions > 0 %>
              <%= unsuccessful_adoptions %>&nbsp;unsuccessful
            <% end %>
          </p>
        <% end %>
        <%# practice awards %>
        <% if has_practice_awards %>
          <p class="margin-bottom-2 font-sans-3xs line-height-sans-3">
            <span class="text-bold text-uppercase">Awards and Recognition:</span>
            <% all_awards = get_all_awards(@practice) %>
            <% if all_awards.length > 180 %>
              <%#= truncate(@all_awards.to_s, start: 0, length: 180) %>
              <span id="awards_truncated"><%= all_awards[0...180]%></span>
              <span id="dots_award">...</span>
              <span id="more_text_award">
                  <%= all_awards %>
              </span>
              <button class="usa-button--unstyled dm-btn-primary font-sans-3xs"
                      onclick="seeMoreTextAwards(); return false;"
                      id="seeMore_award">
                See more
              </button>
            <% else %>
              <%= all_awards %>
            <% end %>
          </p>
        <% end %>
        <%# practice partners %>
        <% if has_practice_partners %>
          <p class="margin-bottom-2 font-sans-3xs line-height-sans-3">
            <span class="text-bold text-uppercase">Partners:</span>
              <% @practice.practice_partners.each_with_index do |partner, index| %>
                <a href="<%= practice_partner_path(partner) %>" class="dm-internal-link">
                  <%= partner.name %>
                </a>
                <%= ", " if @practice.practice_partners.size != index + 1 && @practice.practice_partners.size > 1 %>
              <% end %>
          </p>
        <% end %>
      </div>
    </div>
    <div class="desktop:grid-col-4 mobile-hide">
      <%# practice main display image for desktop %>
      <%= render partial: 'practices/show/desktop_partials/main_display_image_container' %>
      <%# search terms(campaigns/categories/tags) for desktop %>
      <% if @practice.categories.where.not(is_other: true, name: 'Other').any? %>
        <%= render partial: 'practices/show/desktop_partials/search_terms' %>
      <% end %>
    </div>
    <%# practice updates %>
    <%# TODO: reintroduce once update feature is available %>
    <div class="desktop:grid-col-6 grid-col-12 display-none">
      <p class="grid-col-12 margin-bottom-2 font-sans-3xs">
        <span class="text-bold text-uppercase">Recent Updates</span>
      </p>
    </div>
  </div>
</section>
