var CHARACTER_COUNTER_VALID_COLOR =  '#a9aeb1';
var CHARACTER_COUNTER_INVALID_COLOR = '#e52207';
var IMPACT_CAPTION_MAX_LENGTH = 300;

function getPhotoCaptionCharacterCountOnPageLoad() {

    <% @practice.impact_photos.each do |ip| %>
        var impactCaptionTextarea = $("textarea[counter-id='impact_photo_<%= ip.id %>_caption']");
        var impactCaptionCharacterSpan = $("#impact_photo_<%= ip.id %>_caption_character_count");
        var impactCaptionCurrentLength = impactCaptionTextarea.val().length;
        var impactCaptionCharacterCounter = '(' + impactCaptionCurrentLength + '/' + IMPACT_CAPTION_MAX_LENGTH + ' characters)';

        impactCaptionCharacterSpan.text(impactCaptionCharacterCounter);

        if (impactCaptionCurrentLength >= IMPACT_CAPTION_MAX_LENGTH) {
            impactCaptionCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    <% end %>
}

function getVideoCaptionCharacterCountOnPageLoad() {
    <% @practice.video_files.each do |vf| %>
        var impactCaptionTextarea = $("textarea[counter-id='video_file_<%= vf.id %>_caption']");
        var impactCaptionCharacterSpan = $("#video_file_<%= vf.id %>_caption_character_count");
        var impactCaptionCurrentLength = impactCaptionTextarea.val().length;
        var impactCaptionCharacterCounter = '(' + impactCaptionCurrentLength + '/' + IMPACT_CAPTION_MAX_LENGTH + ' characters)';

        impactCaptionCharacterSpan.text(impactCaptionCharacterCounter);

        if (impactCaptionCurrentLength >= IMPACT_CAPTION_MAX_LENGTH) {
            impactCaptionCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    <% end %>
}

function photoCaptionCharacterCounter() {
    $(document).on('input', '.practice-editor-image-caption', function(e) {
        var t = e.target;
        var currentLength = $(t).val().length;

        var impactCaptionCharacterSpan = $(t).closest('div').find('.impact-photo-caption-character-count');
        var characterCounter = '(' + currentLength + '/' + IMPACT_CAPTION_MAX_LENGTH + ' characters)';

        impactCaptionCharacterSpan.css('color', CHARACTER_COUNTER_VALID_COLOR);
        impactCaptionCharacterSpan.text(characterCounter);

        if (currentLength >= IMPACT_CAPTION_MAX_LENGTH) {
            impactCaptionCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    });
}

function videoCaptionCharacterCounter() {
    $(document).on('input', '.practice-editor-video-caption', function(e) {
        var t = e.target;
        var currentLength = $(t).val().length;

        var impactCaptionCharacterSpan = $(t).closest('div').find('.video-file-caption-character-count');
        var characterCounter = '(' + currentLength + '/' + IMPACT_CAPTION_MAX_LENGTH + ' characters)';

        impactCaptionCharacterSpan.css('color', CHARACTER_COUNTER_VALID_COLOR);
        impactCaptionCharacterSpan.text(characterCounter);

        if (currentLength >= IMPACT_CAPTION_MAX_LENGTH) {
            impactCaptionCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    });
}

function denyMultipleMainDisplayImageSelections() {
    $(document).on('click', '.impact-radio', function(e) {
        <%# $('.impact-radio').prop('checked', false); %>
        $('.impact-radio.false').prop('checked', true);
        $(e.target).prop('checked', true);    
    });
}

function makeVideoFileFieldsRequiredIfUsed() {
    $(document).on('input', 'input.video-file-url-input, textarea.practice-editor-video-caption', function() {
        var $inputs = $('input.video-file-url-input, textarea.practice-editor-video-caption');
        $inputs.not(this).prop('required', $(this).val().length);
    });
}

function showFieldsOnPageLoad() {
    <% if @practice.impact_photos.empty? %>
        $('.add-impact-photo-link').click();
        $('.practice-editor-impact-photo-li').appendTo('#sortable_impact_photos');
        initSortable('#sortable_impact_photos');
    <% end %>

    <% if @practice.video_files.empty? %>
        $('.add-video-file-link').click();
        $('.practice-editor-video-file-li').appendTo('#sortable_video_files');
        initSortable('#sortable_video_files');
    <% end %>
}


function executeImpactFunctions() {
    getPhotoCaptionCharacterCountOnPageLoad();
    getVideoCaptionCharacterCountOnPageLoad();
    photoCaptionCharacterCounter();
    videoCaptionCharacterCounter();
    showFieldsOnPageLoad();
    denyMultipleMainDisplayImageSelections();
    makeVideoFileFieldsRequiredIfUsed();
}

$(document).on('turbolinks:load', executeImpactFunctions);