var CHARACTER_COUNTER_VALID_COLOR =  '#a9aeb1';
var CHARACTER_COUNTER_INVALID_COLOR = '#e52207';
var ORIGIN_STORY_MAX_LENGTH = 400;
var PRACTICE_CREATOR_ROLE_MAX_LENGTH = 50;
var PRACTICE_CREATOR_NAME_MAX_LENGTH = 50;

function getOriginStoryCharacterCountOnPageLoad() {

    <%
        id = @practice.id
    %>
    var originStoryTextarea = $("#practice_<%= id %>_origin_story_textarea");
    var originStoryCharacterSpan = $("#practice_<%= id %>_origin_story_character_count");
    var originStoryCurrentLength = originStoryTextarea.val().length;
    var originStoryCharacterCounter = '(' + originStoryCurrentLength + '/' + ORIGIN_STORY_MAX_LENGTH + ' characters)';

    originStoryCharacterSpan.text(originStoryCharacterCounter);

    if (originStoryCurrentLength >= ORIGIN_STORY_MAX_LENGTH) {
        originStoryCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
    }
}

function originStoryCharacterCounter() {
    $('.origin-story-textarea').on('input', function(e) {
        var t = e.target;
        var currentLength = $(t).val().length;

        var originStoryCharacterSpan = $(t).closest('div').find('.origin-story-character-count');
        var characterCounter = '(' + currentLength + '/' + ORIGIN_STORY_MAX_LENGTH + ' characters)';

        originStoryCharacterSpan.css('color', CHARACTER_COUNTER_VALID_COLOR);
        originStoryCharacterSpan.text(characterCounter);

        if (currentLength >= ORIGIN_STORY_MAX_LENGTH) {
            originStoryCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    });
}

function getPracticeCreatorRoleCharacterCountOnPageLoad() {

    <% @practice.practice_creators.each do |pc| %>
        var practiceCreatorInput = $("#practice_creator_<%= pc.id %>_role");
        var practiceCreatorRoleCharacterSpan = $("#practice_creator_<%= pc.id %>_role_character_count");
        var practiceCreatorRoleCurrentLength = practiceCreatorInput.val().length;
        var practiceCreatorRoleCharacterCount = '(' + practiceCreatorRoleCurrentLength + '/' + PRACTICE_CREATOR_ROLE_MAX_LENGTH + ' characters)';

        practiceCreatorRoleCharacterSpan.text(practiceCreatorRoleCharacterCount);

        if (practiceCreatorRoleCharacterCount >= PRACTICE_CREATOR_ROLE_MAX_LENGTH) {
            practiceCreatorRoleCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    <% end %>
}

function practiceCreatorRoleCharacterCounter() {
    $(document).on('input', '.practice-creator-role', function(e) {
        var t = e.target;
        var currentLength = $(t).val().length;

        var practiceCreatorRoleCharacterSpan = $(t).closest('div').find('.practice-creator-role-character-count');
        var characterCounter = '(' + currentLength + '/' + PRACTICE_CREATOR_ROLE_MAX_LENGTH + ' characters)';

        practiceCreatorRoleCharacterSpan.css('color', CHARACTER_COUNTER_VALID_COLOR);
        practiceCreatorRoleCharacterSpan.text(characterCounter);

        if (currentLength >= PRACTICE_CREATOR_ROLE_MAX_LENGTH) {
            practiceCreatorRoleCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    });
}

function getPracticeCreatorNameCharacterCountOnPageLoad() {

    <% @practice.practice_creators.each do |pc| %>
        var practiceCreatorInput = $("#practice_creator_<%= pc.id %>_name");
        var practiceCreatorNameCharacterSpan = $("#practice_creator_<%= pc.id %>_name_character_count");
        var practiceCreatorNameCurrentLength = practiceCreatorInput.val().length;
        var practiceCreatorNameCharacterCount = '(' + practiceCreatorNameCurrentLength + '/' + PRACTICE_CREATOR_NAME_MAX_LENGTH + ' characters)';

        practiceCreatorNameCharacterSpan.text(practiceCreatorNameCharacterCount);

        if (practiceCreatorNameCharacterCount >= PRACTICE_CREATOR_NAME_MAX_LENGTH) {
            practiceCreatorNameCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    <% end %>
}

function practiceCreatorNameCharacterCounter() {
    $(document).on('input', '.practice-creator-name-input', function(e) {
        var t = e.target;
        var currentLength = $(t).val().length;

        var practiceCreatorNameCharacterSpan = $(t).closest('div').find('.practice-creator-name-character-count');
        var characterCounter = '(' + currentLength + '/' + PRACTICE_CREATOR_NAME_MAX_LENGTH + ' characters)';

        practiceCreatorNameCharacterSpan.css('color', CHARACTER_COUNTER_VALID_COLOR);
        practiceCreatorNameCharacterSpan.text(characterCounter);

        if (currentLength >= PRACTICE_CREATOR_NAME_MAX_LENGTH) {
            practiceCreatorNameCharacterSpan.css('color', CHARACTER_COUNTER_INVALID_COLOR);
        }
    });
}

function showFieldsOnPageLoad() {
    <% if @practice.practice_creators.empty? %>
        $('.add-practice-creator-link').click();
        $('.practice-editor-origin-li ').appendTo('#sortable_origins');
        initSortable('#sortable_origins');
    <% end %>
}

function executeOriginFunctions() {
    getOriginStoryCharacterCountOnPageLoad();
    originStoryCharacterCounter();
    showFieldsOnPageLoad();
    getPracticeCreatorRoleCharacterCountOnPageLoad();
    practiceCreatorRoleCharacterCounter();
    getPracticeCreatorNameCharacterCountOnPageLoad();
    practiceCreatorNameCharacterCounter();
}

$(document).on('turbolinks:load', executeOriginFunctions);