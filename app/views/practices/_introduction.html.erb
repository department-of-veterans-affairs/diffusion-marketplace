<%# TODO: Make compatible with IE %>
<%# TODO: Make unauthenticated view %>

<%
  has_main_img = @practice.main_display_image.present?
  updated_at = @practice.updated_at.present? ? @practice.updated_at : @practice.created_at
  completed_adoptions = @practice.number_of_completed_adoptions
  in_progress_adoptions = @practice.number_of_in_progress_adoptions
  unsuccessful_adoptions = @practice.number_of_unsuccessful_adoptions
  has_practice_partners = @practice.practice_partners.any? && @practice.practice_partners.find_by(name: 'None of the above, or Unsure').nil?
  has_practice_awards = @practice.practice_awards.any?
%>

<div class="grid-container">
  <div class="grid-row">
    <div class="desktop:grid-col-12">
      <%# practice main display image %>
      <% if has_main_img %>
        <img
          class="float-right desktop:grid-col-4 grid-col-12 margin-bottom-2 desktop:margin-left-2"
          src="<%= @practice.main_display_image_s3_presigned_url %>"
          alt="<%= @practice.name %> main image"/>
      <% end %>
      <%# practice name %>
      <div class="<%= has_main_img ? 'desktop:grid-col-8' : 'desktop:grid-col-10' %> grid-col-12">
        <h1 class="font-sans-2xl margin-top-0 margin-bottom-1 line-height-sans-2 dm-word-break-break-word dm-hyphens-auto">
          <%= @practice.name %> <%= @practice.short_name if @practice.short_name.present? %>
        </h1>
      </div>
      <%# practice last update timestamp %>
      <p class="<%= has_main_img ? 'desktop:grid-col-8' : 'desktop:grid-col-10' %> grid-col-12 font-sans-3xs text-gray-50 line-height-sans-4 margin-bottom-2">
        <%= updated_at.strftime("Last updated on %B %e, %Y at %I:%M %p") %>
      </p>
      <%# practice actions %>
      <div class="display-flex flex-wrap margin-bottom-2">
        <%# bookmark %>
        <a href="<%= practice_favorite_path(@practice, format: :js) %>" data-method="post" data-remote="true" rel="nofollow" aria-label="Bookmark <%= @practice.name %>" tabindex="-1" aria-hidden="true" class="dm-favorite-practice-link text-no-underline font-sans-xs text-primary desktop:grid-col-2 desktop:margin-right-3 grid-col-6 desktop:margin-bottom-0 margin-bottom-2">
          <i class="<%= current_user.favorite_practice_ids.include?(@practice.id) ? 'fas' : 'far '%> fa-bookmark dm-favorite-icon-<%= @practice.id %>  margin-right-05"></i>
          <span class="dm-favorite-practice-link-text">
            <%= current_user.favorite_practice_ids.include?(@practice.id) ? 'Bookmarked' : 'Bookmark' %>
          </span>
        </a>
        <%# share %>
        <a target="_blank" tabindex="-1" aria-hidden="true"
        aria-label="Share <%= @practice.name %>" href="mailto:?subject=<%= email_practice_subject(@practice) %>&body=<%= email_practice_body(@practice) %>" class="text-no-underline text-primary font-sans-xs desktop:grid-col-2 grid-col-6 desktop:margin-bottom-0 margin-bottom-2">
          <i class="far fa-share-square margin-right-05"></i>
          <span>Share</span>
        </a>
        <%# subscribe %>
        <span class="font-sans-xs text-no-underline text-gray-50 desktop:grid-col-2 desktop:margin-right-3 grid-col-6 margin-bottom-0">
          <i class="far fa-bell margin-right-05"></i>Subscribe
        </span>
        <%# print %>
        <a class="text-no-underline font-sans-xs text-primary desktop:grid-col-2 grid-col-6 margin-bottom-0"
        onclick="window.print(); return false;">
          <i class="fas fa-print margin-right-05"></i>
          <span>Print</span>
        </a>
      </div>
      <%# practice summary %>
      <p class="desktop:grid-col-10 grid-col-12 margin-bottom-2 font-sans-lg line-height-sans-6">
        <%= @practice.summary %>
      </p>
    </div>
  </div>
  <div class="grid-row">
    <%# practice origin date and location %>
    <div class="grid-col-12 margin-bottom-2 display-flex">
      <i class="fas fa-map-marker-alt margin-right-1"></i>
      <span class="font-sans-xs line-height-sans-6 margin-top-neg-05">
        <%= @practice.date_initiated.present? ? date_format(@practice.date_initiated) : '(start date unknown)' %>,
        <%= @facility_data.present? ? @facility_data['OfficialStationName'] : @practice.initiating_facility %>
        <%= show_common_name(@facility_data["OfficialStationName"], @facility_data["CommonName"]) if @facility_data.present?%>
      </span>
    </div>
    <%# practice adoptions %>
    <div class="desktop:float-left desktop:grid-col-6">
      <% if completed_adoptions > 0 || in_progress_adoptions > 0 || unsuccessful_adoptions > 0 %>
        <p class="grid-col-12 margin-bottom-2 font-sans-3xs line-height-sans-3">
          <%# TODO: link adoptions to new diffusion tracker map %>
          <span class="text-bold text-uppercase">Adoptions:</span>
          <% if completed_adoptions > 0 %>
            <%= completed_adoptions %>&nbsp;completed<%= ', ' if in_progress_adoptions > 0 || unsuccessful_adoptions > 0 %>
          <% end %>
          <% if in_progress_adoptions > 0 %>
            <%= in_progress_adoptions %>&nbsp;in-progress<% ', ' if unsuccessful_adoptions > 0 %>
          <% end %>
          <% if unsuccessful_adoptions > 0 %>
            <%= unsuccessful_adoptions %>&nbsp;unsuccessful
          <% end %>
        </p>
      <% end %>
      <%# practice awards %>
      <% if has_practice_awards %>
        <p class="grid-col-12 margin-bottom-2 font-sans-3xs line-height-sans-3">
          <span class="text-bold text-uppercase">Awards and Recognition:</span>
            <% @practice.practice_awards.each_with_index do |award, index| %>
              <span><%= award.name %></span><%= ", " if @practice.practice_awards.size != index + 1 && @practice.practice_awards.size > 1 %>
            <% end %>
        </span>
        </p>
      <% end %>
      <%# practice partners %>
      <% if has_practice_partners %>
        <p class="grid-col-12 margin-bottom-2 font-sans-3xs line-height-sans-3">
          <span class="text-bold text-uppercase">Partners:</span>
            <% @practice.practice_partners.each_with_index do |partner, index| %>
              <a href="<%= practice_partner_path(partner) %>" class="dm-internal-link"><%= partner.name %></a><%= ", " if @practice.practice_partners.size != index + 1 && @practice.practice_partners.size > 1 %>
            <% end %>
        </span>
        </p>
      <% end %>
    </div>
    <%# practice updates %>
    <%# TODO: reintroduce once update feature is available %>
    <div class="desktop:grid-col-6 grid-col-12 display-none">
      <p class="grid-col-12 margin-bottom-2 font-sans-3xs">
        <span class="text-bold text-uppercase">Recent Updates</span>
      </p>
    </div>
  </div>
</div>
