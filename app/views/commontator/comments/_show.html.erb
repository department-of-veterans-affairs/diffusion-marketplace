<%
  # Controllers that use this partial must supply the following variables:
  # user
  # comment
  # nested_children or page
  # show_all
  thread = comment.thread
  nested_children ||= begin
    children = thread.paginated_comments(page, comment.id, show_all)
    thread.nested_comments_for(user, children, show_all)
  end
  creator = comment.creator
  link = Commontator.commontator_link(creator, main_app)
  name = Commontator.commontator_name(creator) || ''
  job_title = creator.job_title
  creator_practice = creator.user_practices.find_by(practice_id: comment.thread.commontable_id, user: creator)
  practice_team_member = creator_practice.team_member
  verified_practice_implementer = creator_practice.verified_implementer
  show_children = params[:show_children] == 'true'
%>

<div class="grid-row margin-bottom-0 margin-top-4">
  <div class="grid-col-auto margin-right-1 avatar-container <%= creator.avatar.present? ? '' : 'width-auto' %> text-center">
    <span id="commontator-comment-<%= comment.id %>-avatar" class="avatar">
      <%= Commontator.commontator_avatar(creator, self) %>
    </span>
  </div>
  <div class="grid-col-fill">
    <div id="commontator-comment-<%= comment.id %>-section-top" class="section top margin-bottom-05">
      <span id="commontator-comment-<%= comment.id %>-author" class="author">
        <%= link.blank? ? name : link_to(name, link) %>
      </span>

      <span id="commontator-comment-<%= comment.id %>-actions" class="actions">
        <%=
          link_to(
            '',
            commontator.edit_comment_path(comment),
            id: "commontator-comment-#{comment.id}-edit",
            class: 'fas fa-edit fa-lg margin-left-105',
            remote: true
          ) if comment.can_be_edited_by?(user)
        %>

        <% if comment.can_be_deleted_by?(user) %>
          <% is_deleted = comment.is_deleted? %>
          <% del_string = is_deleted ? 'undelete' : 'delete' %>
          <%= link_to '',
                      commontator.polymorphic_path([del_string, comment]),
                      data: is_deleted ? { confirm: "Are you sure you want to restore this #{comment.parent.nil? ? 'comment' : 'reply'}?"} : { confirm: "Are you sure you want to delete this #{comment.parent.nil? ? 'comment' : 'reply'}?" },
                      method: :put,
                      id: "commontator-comment-#{comment.id}-#{del_string}",
                      class: is_deleted ? "fas fa-trash-restore-alt fa-lg #{practice_team_member || verified_practice_implementer ? 'margin-left-105' : 'margin-x-105'}" : "fas fa-trash-alt fa-lg #{practice_team_member || verified_practice_implementer ? 'margin-left-105' : 'margin-x-105'} #{practice_team_member || verified_practice_implementer ? '' : 'margin-right-105'}",
                      remote: true %>
        <% end %>
      </span>
      
      <% if practice_team_member %>
        <span class="radius-pill font-sans-2xs bg-gold padding-y-1px padding-x-1 margin-x-105">
          Practice team member
        </span>
      <% elsif verified_practice_implementer %>
        <span class="radius-pill font-sans-2xs bg-gold padding-y-1px padding-x-1 margin-x-105">
          Verified implementer
        </span>
      <% else %>
        <span class="hidden"></span>
      <% end %>

      <% if comment.created_at == comment.updated_at %>
        <span id="commontator-comment-<%= comment.id %>-created-timestamp" class="timestamp <%= practice_team_member || verified_practice_implementer || comment.can_be_deleted_by?(user) ? '' : 'margin-left-105' %>">
          posted <%= timeago(comment.created_at) %>
        </span>
      <% elsif comment.created_at != comment.updated_at && !comment.deleted_at %>
        <span id="commontator-comment-<%= comment.id %>-updated-timestamp" class="timestamp <%= practice_team_member || verified_practice_implementer || comment.can_be_deleted_by?(user) ? '' : 'margin-left-105' %>">
          edited <%= timeago(comment.updated_at) %> (originally posted <%= timeago(comment.created_at) %>)
        </span>
      <% else %>
        <span class="timestamp">
          deleted <%= timeago(comment.deleted_at) %> (originally posted <%= timeago(comment.created_at) %>)
        </span>
      <% end %>
    </div>

    <div id="commontator-comment-<%= comment.id %>-section-middle" class="section middle">
      <div class="text-base margin-bottom-1">
        <%= job_title %>
      </div>

      <div id="commontator-comment-<%= comment.id %>-body" class="body">
        <%= render partial: 'commontator/comments/body', locals: { comment: comment } %>
      </div>
    </div>

    <div id="commontator-comment-<%= comment.id %>-section-bottom" class="section bottom">
      <span id="commontator-comment-<%= comment.id %>-votes" class="votes">
        <%= render partial: 'commontator/comments/votes', locals: { comment: comment, user: user } %>
      </span>
      <% if !comment.parent_id? %>
        <% unless comment.is_deleted? %>
          <span id="commontator-comment-<%= comment.id %>-reply-link" class="reply">
            <%=
              link_to(
                t('commontator.comment.actions.reply'),
                commontator.new_thread_comment_path(thread, comment: { parent_id: comment.id }),
                remote: true
              ) if thread.config.comment_reply_style != :n && !thread.is_closed?
            %>
          </span>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<div class="replies-container margin-left-9 grid-row">
  <% if nested_children.count > 0 %>
    <div class="show-hide-buttons-container grid-col-auto margin-top-2 text-bold" id="comment-<%= comment.id %>-button-container">
      <button data-number-replies="<%= nested_children.count %>" <%= 'disabled' if comment.is_deleted? %> class="usa-button comments-show-hide-button usa-button--unstyled show-hide-button padding-0"><%= !show_children ? "View #{nested_children.count} #{nested_children.count == 1 ? 'reply' : 'replies'} >" : "Hide #{nested_children.count == 1 ? 'reply' : 'replies'} >" %></button>
    </div>
  <% end %>

  <div id="commontator-comment-<%= comment.id %>-children" class="commontator-comment-<%= comment.id %>-children padding-left-3 margin-bottom-0 children <%= 'hidden' unless show_children %>">
    <% if thread.config.comment_order == :l %>
      <div id="commontator-comment-<%= comment.id %>-reply" class="reply margin-0"></div>
    <% end %>

    <%= render partial: 'commontator/comments/list',
              locals: { user: user, nested_comments: nested_children } %>
  </div>
</div>

<% if thread.config.comment_order != :l %>
  <div id="commontator-comment-<%= comment.id %>-reply" class="reply padding-left-9 padding-top-1"></div>
<% end %>



<%#<div id="commontator-comment-<%= comment.id %><%#-pagination" class="comments-pagination">
  <div id="commontator-comment-<%= comment.id %><%#-will-paginate" class="will-paginate">
    <%= will_paginate nested_children,
                      renderer: Commontator::LinkRenderer,
                      name: t('commontator.comment.status.reply_pages'),
                      remote: true,
                      params: { controller: 'commontator/comments',
                                action: 'show',
                                id: comment.id } %>
<%#  </div>
</div>%>
